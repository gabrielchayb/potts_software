{% extends "base.html" %}

{% block header_title %}Importar Exames{% endblock %}
{% block header_subtitle %}Digitalização e Upload para IA{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="max-w-3xl mx-auto">
        <form action="#" method="POST" enctype="multipart/form-data" id="uploadForm">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-8">
                <h2 class="text-xl font-bold text-gray-900 mb-6">Importar Novos Exames</h2>
                
                <input type="file" name="files[]" id="fileInput" class="hidden" multiple accept=".pdf" onchange="handleFileSelect(this)">

                <div id="dropZone" 
                     onclick="document.getElementById('fileInput').click()" 
                     class="border-2 border-dashed border-medical-200 rounded-xl bg-medical-50 p-12 text-center cursor-pointer hover:bg-medical-100 transition group relative">
                    
                    <div id="emptyState">
                        <div class="w-16 h-16 bg-white text-medical-500 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm group-hover:scale-110 transition">
                            <i class="ph ph-cloud-arrow-up text-3xl"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900">Arraste e solte seus PDFs aqui</h3>
                        <p class="text-gray-500 mt-2 mb-6">Ou clique para selecionar do computador</p>
                        
                        <span class="bg-white border border-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-50 pointer-events-none">
                            Selecionar Arquivos
                        </span>
                    </div>

                    <div id="fileList" class="hidden text-left space-y-2">
                        <p class="text-sm font-semibold text-gray-700 mb-3 text-center">Arquivos Prontos para Upload:</p>
                        </div>
                </div>

                <div class="mt-6">
                    <div class="flex justify-between items-center text-xs text-gray-500 mb-2">
                        <span id="uploadStatus">Aguardando arquivos...</span>
                        <span id="uploadSize">0 MB / 10 MB</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                        <div id="progressBar" class="bg-medical-600 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2 flex items-center gap-1">
                        <i class="ph ph-info"></i> Suporta múltiplos arquivos PDF simultaneamente.
                    </p>
                </div>

                <div class="mt-8 flex justify-end gap-3">
                    <a href="{{ url_for('dashboard') }}" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium transition">Cancelar</a>
                    <button type="button" onclick="processUpload()" class="px-6 py-2 bg-medical-600 text-white rounded-lg text-sm font-medium hover:bg-medical-900 shadow-lg shadow-medical-500/30 transition flex items-center gap-2">
                        <span>Processar Exames com IA</span>
                        <i class="ph ph-arrow-right"></i>
                    </button>
                </div>

                <a href="{{ url_for('dashboard') }}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition flex items-center gap-2">
                    <i class="ph ph-arrow-left"></i>
                    <span>Voltar</span>
                </a>
                
            </div>
        </form>
    </div>
</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const emptyState = document.getElementById('emptyState');
    const progressBar = document.getElementById('progressBar');
    const uploadStatus = document.getElementById('uploadStatus');

    // Drag and Drop Effects
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        dropZone.classList.add('border-medical-500', 'bg-medical-100');
    }

    function unhighlight(e) {
        dropZone.classList.remove('border-medical-500', 'bg-medical-100');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    function handleFileSelect(input) {
        handleFiles(input.files);
    }

    function handleFiles(files) {
        if (files.length > 0) {
            // Esconde o estado vazio e mostra a lista
            emptyState.classList.add('hidden');
            fileList.classList.remove('hidden');
            
            // Limpa lista anterior
            fileList.innerHTML = '<p class="text-sm font-semibold text-medical-700 mb-3 text-center"><i class="ph ph-check-circle"></i> Arquivos Selecionados:</p>';

            let totalSize = 0;

            [...files].forEach(file => {
                totalSize += file.size;
                // Cria o elemento visual do arquivo
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 shadow-sm';
                fileItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="ph ph-file-pdf text-red-500 text-xl"></i>
                        <span class="text-sm font-medium text-gray-700">${file.name}</span>
                    </div>
                    <span class="text-xs text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                `;
                fileList.appendChild(fileItem);
            });

            // Atualiza barra de progresso (simulação de carregamento)
            uploadStatus.innerText = "Pronto para processar";
            progressBar.style.width = "100%";
        }
    }

    function processUpload() {
        if (fileInput.files.length === 0) {
            alert('Por favor, selecione pelo menos um arquivo PDF.');
            return;
        }
        
        // Aqui você enviaria o form de verdade
        // document.getElementById('uploadForm').submit(); 
        
        const btn = document.querySelector('button[onclick="processUpload()"]');
        btn.innerHTML = '<i class="ph ph-spinner animate-spin"></i> Enviando para IA...';
        btn.disabled = true;
        
        setTimeout(() => {
            alert('Sucesso! Os exames foram enviados para análise da IA.');
            // Redirecionar ou limpar tela
        }, 1500);
    }
</script>
{% endblock %}